#!/bin/sh

# Function to log with timestamps
log() {
  echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> .husky/logs/pre-push.log
}

# Log the current directory and the directory of the husky.sh file
log "Running pre-push hook"
log "Current directory: $(pwd)"
log "Script directory: $(dirname "$0")"
log "Expected husky.sh path: $(dirname "$0")/../husky.sh"

# Prevent sourcing husky.sh multiple times
if [ -z "$HUSKY_SOURCED" ]; then
  export HUSKY_SOURCED=1
  # Attempt to source the husky.sh file
  if [ -f "$(dirname "$0")/../husky.sh" ]; then
    log "Sourcing husky.sh"
    . "$(dirname "$0")/../husky.sh"
    log "Successfully sourced husky.sh"
  else
    log "Failed to source husky.sh"
    exit 1
  fi
else
  log "husky.sh already sourced, skipping"
fi

# Debugging: Log the current directory and environment variables
log "Environment variables:"
env >> .husky/logs/pre-push.log 2>&1

# Load environment variables
if [ -f .env ]; then
  export $(grep -v '^#' .env | xargs)
fi

# Verify environment variables
log "GITHUB_TOKEN: $GITHUB_TOKEN"
log "REPO_URL: $REPO_URL"

# Run tests
log "Running tests..."
pnpm test >> .husky/logs/pre-push.log 2>&1
if [ $? -ne 0 ]; then
  log "Tests failed"
  exit 1
fi

# Update changelog if on main branch
branch=$(git rev-parse --abbrev-ref HEAD)
log "Current branch: $branch"
if [ "$branch" = "main" ]; then
  log "Updating changelog..."
  pnpm run update-changelog >> .husky/logs/pre-push.log 2>&1
  if [ $? -ne 0 ]; then
    log "Failed to update changelog"
    exit 1
  fi
  git add CHANGELOG.md >> .husky/logs/pre-push.log 2>&1
  git commit -m "Update changelog" >> .husky/logs/pre-push.log 2>&1 || log "No changes to commit"
  git push >> .husky/logs/pre-push.log 2>&1
fi

# Run release-please
pnpm release-please release-pr --token=$GITHUB_TOKEN --repo-url=$REPO_URL --debug
log "Completed pre-push hook"
exit 0